<Window x:Class="AutoEHT.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:AutoEHT.ViewModels"
        Title="Auto EHT - Game Automation" 
        Height="700" Width="1200"
        MinHeight="600" MinWidth="900"
        Background="{StaticResource BackgroundPrimary}"
        WindowStartupLocation="CenterScreen">

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="280"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Left Panel: Instance List -->
        <Border Grid.Column="0" Grid.Row="0" 
                Background="{StaticResource BackgroundSecondary}" 
                Margin="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Border Grid.Row="0" Padding="16,12">
                    <Grid>
                        <TextBlock Text="📱 Instances" Style="{StaticResource Heading}"/>
                        <Button Content="↻" 
                                Style="{StaticResource SmallButton}"
                                HorizontalAlignment="Right"
                                Command="{Binding RefreshInstancesCommand}"
                                ToolTip="Refresh instances"/>
                    </Grid>
                </Border>

                <!-- Select All -->
                <Border Grid.Row="1" Padding="16,8" BorderBrush="{StaticResource Surface}" BorderThickness="0,1">
                    <StackPanel Orientation="Horizontal">
                        <Button Content="Select All" Style="{StaticResource SmallButton}" 
                                Command="{Binding SelectAllCommand}" Margin="0,0,8,0"/>
                        <Button Content="Deselect All" Style="{StaticResource SmallButton}" 
                                Command="{Binding DeselectAllCommand}"/>
                    </StackPanel>
                </Border>

                <!-- Instance List -->
                <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Instances}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource Card}" Margin="8,4">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <!-- Instance Name + Checkbox -->
                                        <StackPanel Grid.Row="0" Orientation="Horizontal">
                                            <CheckBox IsChecked="{Binding IsSelected}" 
                                                      VerticalAlignment="Center" Margin="0,0,8,0"/>
                                            <TextBlock Text="{Binding Name}" Style="{StaticResource Body}" 
                                                       FontWeight="SemiBold"/>
                                        </StackPanel>

                                        <!-- Status -->
                                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,4,0,0">
                                            <Ellipse Width="8" Height="8" Margin="0,0,6,0">
                                                <Ellipse.Style>
                                                    <Style TargetType="Ellipse">
                                                        <Setter Property="Fill" Value="{StaticResource Warning}"/>
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsScriptRunning}" Value="True">
                                                                <Setter Property="Fill" Value="{StaticResource Success}"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsConnected}" Value="False">
                                                                <Setter Property="Fill" Value="{StaticResource Error}"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Ellipse.Style>
                                            </Ellipse>
                                            <TextBlock Text="{Binding StatusText}" Style="{StaticResource Caption}"/>
                                        </StackPanel>

                                        <!-- Actions -->
                                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,8,0,0">
                                            <Button Content="▶ Start"
                                                    Margin="0,0,4,0"
                                                    Command="{Binding DataContext.StartScriptCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}">
                                                <Button.Style>
                                                    <Style TargetType="Button" BasedOn="{StaticResource SmallButton}">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsScriptRunning}" Value="True">
                                                                <Setter Property="IsEnabled" Value="False"/>
                                                            </DataTrigger>
                                                            <DataTrigger Binding="{Binding IsConnected}" Value="False">
                                                                <Setter Property="IsEnabled" Value="False"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                            <Button Content="⏹ Stop"
                                                    Command="{Binding DataContext.StopScriptCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                    CommandParameter="{Binding}">
                                                <Button.Style>
                                                    <Style TargetType="Button" BasedOn="{StaticResource SmallButton}">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsScriptRunning}" Value="False">
                                                                <Setter Property="IsEnabled" Value="False"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Button.Style>
                                            </Button>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>

                <!-- Batch Actions -->
                <Border Grid.Row="3" Padding="16,12" BorderBrush="{StaticResource Surface}" BorderThickness="0,1,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <Button Grid.Column="0" Content="▶▶ Start All" 
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding StartAllCommand}"
                                Margin="0,0,4,0"/>
                        <Button Grid.Column="1" Content="⏹⏹ Stop All" 
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding StopAllCommand}"/>
                    </Grid>
                </Border>
            </Grid>
        </Border>

        <!-- Right Panel: Main Content -->
        <TabControl Grid.Column="1" Grid.Row="0" 
                    Background="{StaticResource BackgroundPrimary}"
                    BorderThickness="0">
            
            <!-- Dashboard Tab -->
            <TabItem Header="Dashboard">
                <Grid Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Script Selector -->
                    <Border Grid.Row="0" Style="{StaticResource Card}" Margin="0,0,0,16">
                        <StackPanel>
                            <TextBlock Text="Script" Style="{StaticResource Heading}" Margin="0,0,0,8"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ComboBox Grid.Column="0" 
                                          ItemsSource="{Binding Scripts}"
                                          SelectedItem="{Binding SelectedScript}"
                                          DisplayMemberPath="Name"
                                          Margin="0,0,8,0"/>
                                <TextBlock Grid.Column="1" 
                                           Text="{Binding SelectedScript.Description}" 
                                           Style="{StaticResource Caption}"
                                           VerticalAlignment="Center"/>
                            </Grid>
                            
                            <!-- Recording Buttons -->
                            <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                                <Button Content="🔴 Start Recording" 
                                        Command="{Binding StartRecordingCommand}"
                                        Margin="0,0,8,0">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource SecondaryButton}">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsRecording}" Value="True">
                                                    <Setter Property="IsEnabled" Value="False"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                <Button Content="⏹ Stop Recording" 
                                        Command="{Binding StopRecordingCommand}">
                                    <Button.Style>
                                        <Style TargetType="Button" BasedOn="{StaticResource SecondaryButton}">
                                            <Setter Property="Background" Value="{StaticResource Error}"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsRecording}" Value="False">
                                                    <Setter Property="IsEnabled" Value="False"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                                <TextBlock Text="🔴 Recording..." 
                                           Foreground="{StaticResource Error}"
                                           VerticalAlignment="Center"
                                           Margin="12,0,0,0">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock" BasedOn="{StaticResource Caption}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding IsRecording}" Value="True">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- Log Panel -->
                    <Border Grid.Row="1" Style="{StaticResource Card}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <Grid Grid.Row="0" Margin="0,0,0,8">
                                <TextBlock Text="Log" Style="{StaticResource Heading}"/>
                                <Button Content="Clear" Style="{StaticResource SmallButton}" 
                                        HorizontalAlignment="Right"
                                        Command="{Binding ClearLogsCommand}"/>
                            </Grid>

                            <ListBox Grid.Row="1" 
                                     ItemsSource="{Binding Logs}"
                                     Background="Transparent"
                                     BorderThickness="0"
                                     FontFamily="Consolas"
                                     FontSize="12">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock>
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Level}" Value="Success">
                                                            <Setter Property="Foreground" Value="{StaticResource Success}"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Level}" Value="Warning">
                                                            <Setter Property="Foreground" Value="{StaticResource Warning}"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Level}" Value="Error">
                                                            <Setter Property="Foreground" Value="{StaticResource Error}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                            <Run Text="{Binding Timestamp, StringFormat='{}{0:HH:mm:ss}'}"/>
                                            <Run Text=" ["/><Run Text="{Binding InstanceName}"/><Run Text="] "/>
                                            <Run Text="{Binding Message}"/>
                                        </TextBlock>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Templates Tab -->
            <TabItem Header="Templates">
                <Grid Margin="16">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" Margin="0,0,0,16">
                        <TextBlock Text="Templates" Style="{StaticResource Heading}"/>
                        <Button Content="+ Add Template" Style="{StaticResource PrimaryButton}" 
                                HorizontalAlignment="Right"/>
                    </Grid>

                    <ItemsControl Grid.Row="1" ItemsSource="{Binding Templates}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Style="{StaticResource Card}" Width="120" Margin="4">
                                    <StackPanel>
                                        <Border Background="{StaticResource BackgroundSecondary}" 
                                                Height="80" CornerRadius="4" Margin="0,0,0,8">
                                            <TextBlock Text="IMG" 
                                                       HorizontalAlignment="Center" 
                                                       VerticalAlignment="Center"
                                                       Foreground="{StaticResource TextSecondary}"/>
                                        </Border>
                                        <TextBlock Text="{Binding Name}" 
                                                   Style="{StaticResource Caption}"
                                                   TextAlignment="Center"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Status Bar -->
        <Border Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" 
                Background="{StaticResource BackgroundSecondary}" 
                Padding="16,8">
            <TextBlock Text="{Binding StatusMessage}" Style="{StaticResource Caption}"/>
        </Border>
    </Grid>
</Window>
